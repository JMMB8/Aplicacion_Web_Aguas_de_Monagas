"use strict";var login=angular.module("loginModule",["pascalprecht.translate","ngSanitize","LocalStorageModule","monospaced.qrcode"]);var isShowenterBt=false;configloginAppModule(login);login.controller("loginCtrl",loginCtrl);login.config(["$httpProvider",function($httpProvider){$httpProvider.interceptors.push(HttpInterceptor)}]);function loginCtrl($translate,$scope,$filter,LoginService,localStorageService){$scope.titlelogo=i18nData["title.logo"];var vm=this;vm.loginmessage="";vm.bean={};vm.login=loginTo;vm.beanLogin={};vm.beanLogin.usesrName="";vm.beanLogin.password="";vm.api=apiUrl;vm.downloadApp=downloadApp;vm.onDownloadResult=onDownloadResult;vm.bean.noticeList={};vm.consumerUserName=localStorageService.get(ZBuserNameKey);if(vm.consumerUserName!=""&&vm.consumerUserName!=null){angular.element("#loginBt").hide();angular.element("#enterBt").show();isShowenterBt=true}else{angular.element("#loginBt").show();angular.element("#enterBt").hide()}function loginTo(){if(!checkExploreVersion()){return false}removeLocalStorage(localStorageService);$("#loginBth").hide();$("p").attr("id","statusTipss");$("#statusTips").text("");$("#shclDefault").show();$("#shclDefault").shCircleLoader();if((vm.bean.userName==""||vm.bean.userName==null)&&(vm.bean.password==""||vm.bean.password==null)){alert($translate.instant("login.userName.password.notempty"));$("#shclDefault").hide();$("#loginBth").show();angular.element("#idNumber").closest("div").addClass("has-error");$("#shclDefault").hide();$("#loginBth").show();angular.element("#password").closest("div").addClass("has-error");return}else{angular.element("#idNumber").closest("div").removeClass("has-error");angular.element("#password").closest("div").removeClass("has-error")}if(vm.bean.userName==""||vm.bean.userName==null){alert($translate.instant("login.userName.notempty"));$("#shclDefault").hide();$("#loginBth").show();angular.element("#idNumber").closest("div").addClass("has-error");return}else{angular.element("#idNumber").closest("div").removeClass("has-error")}if(vm.bean.password==""||vm.bean.password==null){alert($translate.instant("login.password.notempty"));$("#shclDefault").hide();$("#loginBth").show();angular.element("#password").closest("div").addClass("has-error");return}else{angular.element("#password").closest("div").removeClass("has-error")}if(vm.bean.password.length!=6){alert($translate.instant("login.login.password.length.error"));$("#shclDefault").hide();$("#loginBth").show();angular.element("#password").closest("div").addClass("has-error");return}else{angular.element("#password").closest("div").removeClass("has-error")}if(/^([a-zA-Z]{6}$)/.test(vm.bean.password)){alert($translate.instant("login.password.all.number.letter"));$("#shclDefault").hide();$("#loginBth").show();angular.element("#password").closest("div").addClass("has-error");return}else{angular.element("#password").closest("div").removeClass("has-error")}if(!/^(?![0-9]+$)(?![a-zA-Z]+$)[0-9A-Za-z]{6}$/.test(vm.bean.password)&&!/^([0-9]{6}$)/.test(vm.bean.password)){alert($translate.instant("login.password.special.characters"));$("#shclDefault").hide();$("#loginBth").show();angular.element("#password").closest("div").addClass("has-error");return}else{angular.element("#password").closest("div").removeClass("has-error")}var idNumberPrefix=$("#idNumberPrefix").val();vm.loginmessage="";vm.beanLogin.userName="10_"+idNumberPrefix+vm.bean.userName;vm.beanLogin.password=vm.bean.password;LoginService.login(vm.beanLogin).then(onResultData,function(errResponse){vm.loginmessage=$translate.instant("common.address.notuseful")})}function onResultData(data){$("#loginBth").hide();if(data.statusCode=="LOGIN_USER_NAME_PASSWORD_ERROR"){var remainingTimes=data.body.remainingTimes;vm.loginmessage=getErrMessage("LOGIN_USER_NAME_PASSWORD_ERROR_TIME").replace("{0}",remainingTimes)}else{vm.loginmessage=getErrMessage(data.statusCode)}if(data.statusCode=="OK"){$("p").attr("id","statusTips");var tokenRandomValue=randomWord(false,43);var encodeToken=encryptByDES(data.body.token,tokenRandomValue);localStorageService.set(tokenKey,encodeToken);localStorageService.set(tokenRandomKey,tokenRandomValue);localStorageService.set(ZBuserNameKey,data.body.userName);var encodeUserId=encryptByDES(data.body.userId,tokenRandomValue);localStorageService.set(ZBuserIdKey,encodeUserId);var encodeIdNumber=encryptByDES(data.body.idNumber,tokenRandomValue);localStorageService.set(ZBidNumber,encodeIdNumber);localStorageService.set(ZBisDefaultPassword,data.body.isDefaultPassword);localStorageService.set(ZBisDefaultPayPassword,data.body.isDefaultPayPassword);localStorageService.set(ZBemailBindStatus,data.body.emailBindStatus);localStorageService.set(ZBshownNotRemind,0);if(!showFirstLoginWindows(localStorageService)){window.location="index.html"}}else{$("#shclDefault").hide();$("#loginBth").show()}}vm.qrcodeUrl="";var androidUrl="";var iphoneUrl="";var winPhoneUrl="";onDownloadResult(1,1,true);function onDownloadResult(type,platformType,qrFlag){LoginService.downloadApp(type,platformType).then(function(data){if(data!=null&&data.body[0]!=null&&data.body[0].fileUrl!=null){var fileName=data.body[0].fileUrl;if(qrFlag){vm.qrcodeUrl=apiUrl+"/app/downloadBuyerAndroidApp"}if(platformType==1){androidUrl=apiUrl+"/app/downloadBuyerAndroidApp"}return apiUrl+"/app/downloadBuyerAndroidApp"}else{return"#"}},function(errResponse){console.log($translate.instant("common.address.notuseful"))})}function downloadApp(){vm.onDownloadResult(1,1,false);if(androidUrl!=null&&"#"!=androidUrl){window.open(androidUrl)}else{window.location="#"}}vm.enterIndex=function(){LoginService.refresh(vm.userId=decryptByDES(localStorageService.get(ZBuserIdKey),localStorageService.get(tokenRandomKey))).then(function(data){if(data!=null&&data.statusCode=="OK"){var tokenRandomValue=randomWord(false,43);var encodeToken=encryptByDES(data.body.token,tokenRandomValue);localStorageService.set(tokenKey,encodeToken);localStorageService.set(tokenRandomKey,tokenRandomValue);localStorageService.set(ZBuserNameKey,data.body.userName);var encodeUserId=encryptByDES(data.body.userId,tokenRandomValue);localStorageService.set(ZBuserIdKey,encodeUserId);var encodeIdNumber=encryptByDES(data.body.idNumber,tokenRandomValue);localStorageService.set(ZBidNumber,encodeIdNumber);localStorageService.set(ZBisDefaultPassword,data.body.isDefaultPassword);localStorageService.set(ZBisDefaultPayPassword,data.body.isDefaultPayPassword);localStorageService.set(ZBemailBindStatus,data.body.emailBindStatus);localStorageService.set(ZBshownNotRemind,0);if(!showFirstLoginWindows(localStorageService)){window.location="index.html"}}else{goExit(LoginService,localStorageService)}},function(err){goExit(LoginService,localStorageService)})};vm.exit=function(){goExit(LoginService,localStorageService)};vm.goMy=function(){goMy(localStorageService)};vm.goIndex=function(){goIndex(localStorageService)};vm.goMyBill=function(){goMyBill(localStorageService)};var start=0;var length=2;var recordsTotal=0;var pageSize=2;var startPage=1;LoginService.getAppNotice(start,length).then(function(success){if(success!=null&&success.statusCode=="OK"){if(success.body.length>0){vm.bean.noticeList=success.body;for(var i=0;i<vm.bean.noticeList.length;i++){vm.bean.noticeList[i].content=fixText(vm.bean.noticeList[i].content)}recordsTotal=success.recordsTotal;console.log(recordsTotal);var totalPageNum=parseInt((recordsTotal+pageSize-1)/pageSize);vm.totalPageNum=totalPageNum;Page({num:totalPageNum,startnum:startPage,elem:$("#page1"),callback:function(n){startPage=n;start=(n-1)*pageSize;LoginService.getAppNotice(start,length).then(function(success){if(success.statusCode=="OK"){vm.bean.noticeList=success.body;for(var i=0;i<vm.bean.noticeList.length;i++){vm.bean.noticeList[i].content=fixText(vm.bean.noticeList[i].content)}}},function(err){})}})}}},function(err){alert("Can not connect to the server!")});function fixText(text){var replaceRegex=/(\n\r|\r\n|\r|\n)/g;text=text||"";return text.replace(replaceRegex,"<br/>")}};